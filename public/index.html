<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Set Card Game - Multiplayer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        h1 {
            color: white;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        /* Lobby Screen */
        .lobby {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
            max-width: 500px;
            width: 100%;
        }

        .lobby h2 {
            color: #667eea;
            margin-bottom: 20px;
            text-align: center;
        }

        .lobby input {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }

        .lobby input:focus {
            outline: none;
            border-color: #667eea;
        }

        .lobby button {
            width: 100%;
            padding: 12px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            margin-bottom: 10px;
            transition: background 0.3s;
        }

        .lobby button:hover {
            background: #5568d3;
        }

        .divider {
            text-align: center;
            margin: 20px 0;
            color: #999;
        }

        /* Waiting Room */
        .waiting-room {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
            max-width: 600px;
            width: 100%;
        }

        .waiting-room h2 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .room-code {
            background: #f0f4ff;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 20px;
        }

        .room-code-label {
            font-size: 14px;
            color: #666;
            margin-bottom: 5px;
        }

        .room-code-value {
            font-size: 32px;
            font-weight: bold;
            color: #667eea;
            letter-spacing: 3px;
        }

        .players-list {
            margin-bottom: 20px;
        }

        .player-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .player-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
        }

        .player-name {
            flex: 1;
            font-weight: 500;
        }

        .player-score {
            background: #667eea;
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 14px;
        }

        /* Game Screen */
        .game-screen {
            display: none;
            max-width: 1200px;
            width: 100%;
        }

        .game-info {
            background: white;
            padding: 15px 30px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: flex;
            gap: 30px;
            align-items: center;
            justify-content: space-between;
        }

        .info-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .info-label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .info-value {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
        }

        .controls {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.3s;
        }

        button:hover {
            background: #5568d3;
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .message {
            background: white;
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            min-height: 30px;
            font-weight: bold;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            text-align: center;
        }

        .message.success {
            background: #4caf50;
            color: white;
        }

        .message.error {
            background: #f44336;
            color: white;
        }

        .message.info {
            background: #2196f3;
            color: white;
        }

        .players-sidebar {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .players-sidebar h3 {
            margin-bottom: 15px;
            color: #667eea;
        }

        .board {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .card {
            background: white;
            border: 3px solid #ddd;
            border-radius: 10px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s;
            aspect-ratio: 2/3;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: relative;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.2);
        }

        .card.selected {
            border-width: 4px;
            transform: translateY(-5px);
        }

        .card.my-selection {
            background: #f0f4ff;
        }

        .card.hint-highlight {
            border-color: #ffc107;
            border-width: 4px;
            box-shadow: 0 0 12px rgba(255, 193, 7, 0.5);
        }

        .card-shapes {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .card-shapes svg {
            width: 70px;
            height: 30px;
        }

        /* Game Over Overlay */
        .game-over-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }

        .game-over-card {
            background: white;
            border-radius: 15px;
            padding: 40px;
            max-width: 450px;
            width: 90%;
            text-align: center;
            box-shadow: 0 12px 24px rgba(0,0,0,0.3);
        }

        .game-over-card h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 28px;
        }

        .game-over-card .winner-name {
            font-size: 22px;
            font-weight: bold;
            color: #333;
            margin-bottom: 20px;
        }

        .game-over-card .final-scores {
            margin-bottom: 25px;
        }

        .game-over-card .final-scores .player-item {
            justify-content: center;
        }

        .game-over-card button {
            width: 100%;
            padding: 14px;
            font-size: 18px;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .hidden {
            display: none !important;
        }

        @media (max-width: 768px) {
            .board {
                grid-template-columns: repeat(3, 1fr);
            }
            .card-shapes svg {
                width: 50px;
                height: 22px;
            }
        }
    </style>
</head>
<body>
    <h1>Set Card Game - Multiplayer</h1>

    <!-- Lobby Screen -->
    <div id="lobby" class="lobby">
        <h2>Welcome to Set!</h2>
        <input type="text" id="playerName" placeholder="Enter your name" maxlength="20">
        <button onclick="createRoom()">Create New Game</button>

        <div class="divider">- OR -</div>

        <input type="text" id="roomCode" placeholder="Enter room code" maxlength="6">
        <button onclick="joinRoom()">Join Game</button>
    </div>

    <!-- Waiting Room -->
    <div id="waitingRoom" class="waiting-room hidden">
        <h2>Waiting for players...</h2>

        <div class="room-code">
            <div class="room-code-label">Room Code</div>
            <div class="room-code-value" id="displayRoomCode"></div>
        </div>

        <div class="players-list">
            <h3>Players</h3>
            <div id="waitingPlayers"></div>
        </div>

        <button onclick="startGame()" id="startGameBtn">Start Game</button>
    </div>

    <!-- Game Screen -->
    <div id="gameScreen" class="game-screen">
        <div class="game-info">
            <div class="info-item">
                <span class="info-label">Room Code</span>
                <span class="info-value" id="gameRoomCode"></span>
            </div>
            <div class="info-item">
                <span class="info-label">Cards Left</span>
                <span class="info-value" id="cardsLeft">81</span>
            </div>
        </div>

        <div class="controls">
            <button onclick="requestHint()">Hint</button>
            <button onclick="add3Cards()">Add 3 Cards</button>
            <button onclick="leaveGame()">Leave Game</button>
        </div>

        <div class="message" id="message"></div>

        <div class="players-sidebar" id="playersSidebar">
            <h3>Players</h3>
            <div id="playersDisplay"></div>
        </div>

        <div class="board" id="board"></div>
    </div>

    <!-- Game Over Overlay (inserted dynamically) -->
    <div id="gameOverOverlay" class="game-over-overlay hidden"></div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let myPlayerId = null;
        let currentRoomId = null;
        let gameState = null;
        let mySelection = [];

        // --- XSS prevention ---
        function escapeHtml(str) {
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        // --- SVG shape rendering ---
        const COLORS = {
            red: '#e53935',
            green: '#43a047',
            purple: '#8e24aa'
        };

        function createSvgShape(shape, color, shading) {
            const c = COLORS[color];
            const patternId = `stripe-${color}-${Math.random().toString(36).slice(2, 8)}`;
            let defs = '';
            let fill;

            if (shading === 'solid') {
                fill = c;
            } else if (shading === 'empty') {
                fill = 'transparent';
            } else {
                // striped
                defs = `<defs><pattern id="${patternId}" patternUnits="userSpaceOnUse" width="5" height="5" patternTransform="rotate(45)"><line x1="0" y1="0" x2="0" y2="5" stroke="${c}" stroke-width="2"/></pattern></defs>`;
                fill = `url(#${patternId})`;
            }

            let path;
            if (shape === 'diamond') {
                path = `<polygon points="35,2 68,15 35,28 2,15" fill="${fill}" stroke="${c}" stroke-width="2"/>`;
            } else if (shape === 'oval') {
                path = `<rect x="2" y="2" width="66" height="26" rx="13" ry="13" fill="${fill}" stroke="${c}" stroke-width="2"/>`;
            } else {
                // squiggle
                path = `<path d="M5,25 C5,10 15,2 25,2 C35,2 35,12 45,12 C55,12 65,5 65,15 C65,20 55,28 45,28 C35,28 35,18 25,18 C15,18 5,25 5,25 Z" fill="${fill}" stroke="${c}" stroke-width="2"/>`;
            }

            return `<svg viewBox="0 0 70 30" xmlns="http://www.w3.org/2000/svg">${defs}${path}</svg>`;
        }

        // Lobby functions
        function createRoom() {
            const playerName = document.getElementById('playerName').value.trim();
            if (!playerName) {
                alert('Please enter your name');
                return;
            }
            socket.emit('createRoom', playerName);
        }

        function joinRoom() {
            const playerName = document.getElementById('playerName').value.trim();
            const roomCode = document.getElementById('roomCode').value.trim().toUpperCase();

            if (!playerName) {
                alert('Please enter your name');
                return;
            }
            if (!roomCode) {
                alert('Please enter room code');
                return;
            }

            socket.emit('joinRoom', { roomId: roomCode, playerName });
        }

        function startGame() {
            socket.emit('startGame', currentRoomId);
        }

        function restartGame() {
            document.getElementById('gameOverOverlay').classList.add('hidden');
            socket.emit('restartGame', currentRoomId);
        }

        function leaveGame() {
            location.reload();
        }

        // Game functions
        function selectCard(index) {
            if (!gameState || !gameState.gameStarted || gameState.gameOver) return;
            socket.emit('selectCard', { roomId: currentRoomId, cardIndex: index });
        }

        function requestHint() {
            socket.emit('requestHint', currentRoomId);
        }

        function add3Cards() {
            socket.emit('add3Cards', currentRoomId);
        }

        // Socket event handlers
        socket.on('roomCreated', ({ roomId, player }) => {
            currentRoomId = roomId;
            myPlayerId = player.id;
            showWaitingRoom(roomId);
        });

        socket.on('roomJoined', ({ roomId, player }) => {
            currentRoomId = roomId;
            myPlayerId = player.id;
            showWaitingRoom(roomId);
        });

        socket.on('gameState', (state) => {
            gameState = state;

            if (state.gameStarted && !state.gameOver) {
                document.getElementById('gameOverOverlay').classList.add('hidden');
                showGameScreen();
                updateGameUI(state);
            } else if (state.gameOver) {
                updateGameUI(state);
                showGameOver(state);
            } else {
                updateWaitingRoom(state);
            }
        });

        socket.on('gameStarted', (state) => {
            gameState = state;
            document.getElementById('gameOverOverlay').classList.add('hidden');
            showGameScreen();
            updateGameUI(state);
            showMessage('Game started! Find those sets!', 'success');
        });

        socket.on('cardSelected', ({ playerId, cardIndex, selectedCards }) => {
            if (playerId === myPlayerId) {
                mySelection = selectedCards;
            }
            renderBoard();
        });

        socket.on('validSet', ({ playerId, playerName, score }) => {
            const isMe = playerId === myPlayerId;
            const safeName = escapeHtml(playerName);
            const message = isMe ?
                `You found a set! Score: ${score}` :
                `${safeName} found a set!`;
            showMessage(message, 'success');
            mySelection = [];
        });

        socket.on('invalidSet', ({ playerId, playerName }) => {
            const isMe = playerId === myPlayerId;
            const safeName = escapeHtml(playerName);
            const message = isMe ?
                'Not a valid set. Try again!' :
                `${safeName} tried an invalid set`;
            showMessage(message, 'error');
            mySelection = [];
        });

        socket.on('playerJoined', ({ player }) => {
            showMessage(`${escapeHtml(player.name)} joined the game`, 'info');
        });

        socket.on('playerLeft', ({ playerId }) => {
            showMessage('A player left the game', 'info');
        });

        socket.on('hint', ({ indices }) => {
            showMessage(`Hint: look at the highlighted cards`, 'info');

            const cards = document.querySelectorAll('.card');
            indices.forEach(i => {
                cards[i]?.classList.add('hint-highlight');
            });

            setTimeout(() => {
                indices.forEach(i => {
                    cards[i]?.classList.remove('hint-highlight');
                });
                showMessage('');
            }, 3000);
        });

        socket.on('cardsAdded', () => {
            showMessage('Added 3 cards to the board', 'success');
            setTimeout(() => showMessage(''), 1500);
        });

        socket.on('gameOver', ({ winner, players }) => {
            showGameOver({ winner, players });
        });

        socket.on('error', ({ message }) => {
            showMessage(message, 'error');
        });

        // UI functions
        function showWaitingRoom(roomId) {
            document.getElementById('lobby').classList.add('hidden');
            document.getElementById('waitingRoom').classList.remove('hidden');
            document.getElementById('displayRoomCode').textContent = roomId;
        }

        function updateWaitingRoom(state) {
            const container = document.getElementById('waitingPlayers');
            container.innerHTML = '';
            state.players.forEach(player => {
                const item = document.createElement('div');
                item.className = 'player-item';

                const colorDot = document.createElement('div');
                colorDot.className = 'player-color';
                colorDot.style.background = player.color;

                const name = document.createElement('div');
                name.className = 'player-name';
                name.textContent = player.name;

                item.appendChild(colorDot);
                item.appendChild(name);
                container.appendChild(item);
            });
        }

        function showGameScreen() {
            document.getElementById('lobby').classList.add('hidden');
            document.getElementById('waitingRoom').classList.add('hidden');
            document.getElementById('gameScreen').style.display = 'block';
        }

        function updateGameUI(state) {
            document.getElementById('gameRoomCode').textContent = state.roomId;
            document.getElementById('cardsLeft').textContent = state.deckSize;

            // Update players using DOM APIs (XSS-safe)
            const playersContainer = document.getElementById('playersDisplay');
            playersContainer.innerHTML = '';
            [...state.players]
                .sort((a, b) => b.score - a.score)
                .forEach(player => {
                    const item = document.createElement('div');
                    item.className = 'player-item';

                    const colorDot = document.createElement('div');
                    colorDot.className = 'player-color';
                    colorDot.style.background = player.color;

                    const name = document.createElement('div');
                    name.className = 'player-name';
                    name.textContent = player.name + (player.id === myPlayerId ? ' (You)' : '');

                    const score = document.createElement('div');
                    score.className = 'player-score';
                    score.textContent = player.score;

                    item.appendChild(colorDot);
                    item.appendChild(name);
                    item.appendChild(score);
                    playersContainer.appendChild(item);
                });

            renderBoard();
        }

        function renderBoard() {
            if (!gameState) return;

            const boardEl = document.getElementById('board');
            boardEl.innerHTML = '';

            gameState.board.forEach((card, index) => {
                const cardEl = document.createElement('div');
                cardEl.className = 'card';

                if (mySelection.includes(index)) {
                    cardEl.classList.add('selected', 'my-selection');
                    const myPlayer = gameState.players.find(p => p.id === myPlayerId);
                    if (myPlayer) {
                        cardEl.style.borderColor = myPlayer.color;
                    }
                } else {
                    for (let [playerId, selection] of Object.entries(gameState.selections || {})) {
                        if (selection.includes(index) && playerId !== myPlayerId) {
                            cardEl.classList.add('selected');
                            const player = gameState.players.find(p => p.id === playerId);
                            if (player) {
                                cardEl.style.borderColor = player.color;
                            }
                        }
                    }
                }

                const shapesContainer = document.createElement('div');
                shapesContainer.className = 'card-shapes';
                for (let i = 0; i < card.number; i++) {
                    shapesContainer.insertAdjacentHTML('beforeend',
                        createSvgShape(card.shape, card.color, card.shading));
                }
                cardEl.appendChild(shapesContainer);

                cardEl.addEventListener('click', () => selectCard(index));
                boardEl.appendChild(cardEl);
            });
        }

        function showMessage(text, type = '') {
            const msgEl = document.getElementById('message');
            msgEl.textContent = text;
            msgEl.className = 'message ' + type;
        }

        function showGameOver(state) {
            const overlay = document.getElementById('gameOverOverlay');
            overlay.innerHTML = '';
            overlay.classList.remove('hidden');

            const card = document.createElement('div');
            card.className = 'game-over-card';

            const title = document.createElement('h2');
            title.textContent = 'Game Over!';
            card.appendChild(title);

            if (state.winner) {
                const winner = document.createElement('div');
                winner.className = 'winner-name';
                winner.textContent = `${state.winner.name} wins with ${state.winner.score} sets!`;
                card.appendChild(winner);
            }

            const scoresDiv = document.createElement('div');
            scoresDiv.className = 'final-scores';
            const sortedPlayers = [...(state.players || (gameState && gameState.players) || [])]
                .sort((a, b) => b.score - a.score);
            sortedPlayers.forEach(player => {
                const item = document.createElement('div');
                item.className = 'player-item';

                const colorDot = document.createElement('div');
                colorDot.className = 'player-color';
                colorDot.style.background = player.color;

                const name = document.createElement('div');
                name.className = 'player-name';
                name.textContent = player.name;

                const score = document.createElement('div');
                score.className = 'player-score';
                score.textContent = player.score;

                item.appendChild(colorDot);
                item.appendChild(name);
                item.appendChild(score);
                scoresDiv.appendChild(item);
            });
            card.appendChild(scoresDiv);

            const playAgainBtn = document.createElement('button');
            playAgainBtn.textContent = 'Play Again';
            playAgainBtn.addEventListener('click', restartGame);
            card.appendChild(playAgainBtn);

            const leaveBtn = document.createElement('button');
            leaveBtn.textContent = 'Leave Game';
            leaveBtn.className = 'btn-secondary';
            leaveBtn.addEventListener('click', leaveGame);
            card.appendChild(leaveBtn);

            overlay.appendChild(card);
        }
    </script>
</body>
</html>
